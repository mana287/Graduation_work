<div class="container-fluid">
  <div class="row">
    <%= render "shared/sidebar" %>

    <main class="col py-4">
      <div class="d-flex justify-content-end mb-3">
        <%= link_to "← 記事一覧に戻る", articles_path, class: "btn btn-sm btn-outline-secondary" %>
      </div>

      <div class="row g-4">
        <!-- 左：画像 + 指標（いいね/コメント） -->
        <div class="col-12 col-lg-5 d-flex flex-column align-items-start">
          <div
            class="rounded shadow-sm border overflow-hidden mx-auto mx-lg-0"
            style="--img-size: 320px; width: min(100%, var(--img-size)); aspect-ratio: 1 / 1;"
          >
            <% if @article.image.attached? %>
              <%= image_tag @article.image,
                    class: "w-100 h-100",
                    style: "object-fit: cover;",
                    alt: @article.title %>
            <% else %>
              <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center">
                <i class="bi bi-image text-muted fs-1"></i>
              </div>
            <% end %>
          </div>

          <!-- 画像の下：いいね数 / コメント数 -->
          <div class="d-flex align-items-center gap-3 mt-2 small text-muted">
            <span>
              <i class="bi bi-hand-thumbs-up"></i>
              <%= @article.respond_to?(:likes_count) ? @article.likes_count.to_i : 0 %>
            </span>
            <span>
              <i class="bi bi-chat-left-text"></i>
              <%= @article.respond_to?(:comments) ? @article.comments.size : 0 %>
            </span>
          </div>
        </div>

        <!-- 右：プロフィール + タイトル + 投稿者名 + 本文 + タグ + 追加情報 -->
        <div class="col-12 col-lg-6">
          <!-- プロフィール画像の横にタイトル -->
          <div class="d-flex align-items-start gap-3">
            <!-- 仮アバター（後でユーザーアイコンに差し替え） -->
            <div class="flex-shrink-0">
              <div class="rounded-circle bg-secondary-subtle d-flex align-items-center justify-content-center border"
                   style="width:56px; height:56px;">
                <i class="bi bi-person text-secondary fs-3"></i>
              </div>
            </div>

            <div class="flex-grow-1">
              <h1 class="h5 mb-1"><%= @article.title %></h1>
              <div class="text-muted small">
                投稿者：<%= @article.user&.name || @article.guest_name || "ゲスト" %>
              </div>

              <% if @article.kind.present? %>
                <div class="mt-2">
                  <span class="badge text-bg-light border">
                    <%= @article.shop? ? "店舗" : "商品" %>
                  </span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- 本文 -->
          <div class="mt-3">
            <h2 class="h6 text-muted">本文</h2>
            <div><%= simple_format(@article.body) %></div>
          </div>

          <!-- タグ -->
          <% tags_text = @article.try(:tags_text).presence || @article.try(:tag_names).presence %>
          <% if tags_text.present? %>
            <div class="mt-3">
              <div class="d-flex flex-wrap gap-2">
                <% tags_text.split(/[、,\s]+/).reject(&:blank?).each do |tag| %>
                  <span class="badge rounded-pill tag-chip"><%= tag %></span>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 追加情報（店舗/商品で見出しを切替） -->
          <% if @article.extra_info.present? %>
            <div class="mt-3">
              <h2 class="h6 text-muted"><%= @article.shop? ? "店舗情報" : "商品情報" %></h2>
              <div><%= simple_format(@article.extra_info) %></div>
            </div>
          <% end %>

          <%# 下：編集／削除（本人のみ） %>
          <% if current_user&.id == @article.user_id %>
            <div class="d-flex justify-content-start gap-2 mt-4 border-top pt-3">
              <%= link_to edit_article_path(@article), class: "btn btn-sm btn-outline-primary" do %>
                <i class="bi bi-pencil"></i> 編集
              <% end %>

              <%= button_to article_path(@article),
                    method: :delete,
                    form: { class: "d-inline" },
                    data: { turbo_confirm: "本当に削除しますか？" },
                    class: "btn btn-sm btn-outline-danger" do %>
                <i class="bi bi-trash"></i> 削除
              <% end %>
            </div>
          <% end %>
        </div>
      </div>    
    </main>
  </div>
</div>
